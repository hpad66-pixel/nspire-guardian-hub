
# Project Progress Report Generator — Weekly Summary & Monthly Invoice Report

## Overview

This feature adds a **"Reports" button** in the project header that opens a modal allowing users to generate two distinct AI-powered, branded documents:

1. **Weekly Progress Summary** — An executive-style accountability report covering all activity in the past 7 days (daily logs, milestones, RFIs, punch list, safety, communications). Audience: internal teams and stakeholders.

2. **Monthly Invoice Backup Report** — A formal, billable-progress document formatted like a professional consultant's invoice support package: work completed, costs incurred, % progress against budget, change orders, and deliverables. Audience: clients and billing departments.

Both documents are:
- Branded with the current user's **company branding** (from `company_branding` table — name, logo, colors, address, contact info). Falls back to "APAS Consulting" if no branding is configured.
- Generated by **AI (Gemini 2.0 Flash via your API key)** using all live project data.
- Editable via rich text editor before finalizing.
- Exportable as **PDF** or **Word (.docx)** document.
- Sendable via **email** directly from the interface.
- Saveable to the database so reports can be reviewed and re-downloaded later.

---

## Data Sources Aggregated Per Report

All data is pulled live from the database for the selected project:

| Data Source | DB Table / Hook |
|---|---|
| Project details (budget, dates, status) | `projects` |
| Milestones completed/pending | `project_milestones` |
| Daily logs submitted | `daily_reports` |
| Change orders (pending/approved) | `change_orders` |
| RFIs (open/answered) | `project_rfis` |
| Punch list items | `punch_items` |
| Safety incidents | `project_safety_incidents` |
| Progress/Earned Value metrics | `project_progress_entries` |
| Activity feed (calls, site visits, emails) | `project_communications` |
| Meeting minutes (finalized) | `project_meetings` |
| Company branding | `company_branding` |

---

## Database Changes

One new table: `project_progress_reports` — to save generated reports for history/re-download:

```sql
CREATE TABLE public.project_progress_reports (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
  report_type TEXT NOT NULL CHECK (report_type IN ('weekly', 'monthly_invoice')),
  report_period_start DATE NOT NULL,
  report_period_end DATE NOT NULL,
  title TEXT NOT NULL,
  content_html TEXT,
  status TEXT NOT NULL DEFAULT 'draft' CHECK (status IN ('draft', 'finalized')),
  generated_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

ALTER TABLE public.project_progress_reports ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can manage their own reports"
  ON public.project_progress_reports
  FOR ALL USING (auth.uid() = generated_by);
```

---

## New Edge Function: `generate-progress-report`

Mirrors the `generate-proposal` function pattern. It:
1. Receives `{ projectId, reportType, periodStart, periodEnd, userNotes }`
2. Fetches **all project data** (milestones, daily reports, change orders, RFIs, punch items, safety, communications, meetings, progress entries, branding) in one batch
3. Constructs a rich, data-dense prompt for Gemini 2.0 Flash
4. Returns AI-generated HTML formatted for the specific report type
5. Streams back as SSE (matching the existing proposal pattern)

**Weekly Report prompt structure:**
- Executive summary of the week
- Milestones completed vs. planned
- Daily activity log summary
- Issues & RFIs raised/resolved
- Safety observations
- Communications log summary
- Risks & action items

**Monthly Invoice Report prompt structure:**
- Cover page with project + client + billing period info
- Executive summary of progress
- Detailed scope of work completed (by trade/discipline)
- Schedule performance vs. baseline
- Financial summary: original contract, approved COs, spent to date, % billed
- Earned value analysis (CPI/SPI)
- Deliverables submitted this period
- Outstanding items and next steps

---

## New UI Components

### 1. `ReportGeneratorDialog` (new file: `src/components/projects/ReportGeneratorDialog.tsx`)

A multi-step modal dialog:

**Step 1 — Configure:**
- Select report type: "Weekly Progress Summary" or "Monthly Invoice Report"
- Date range picker (auto-defaults to last 7 days or last calendar month)
- Optional notes field ("Add any context you want AI to emphasize")
- Preview of data that will be included (counts: X daily logs, Y milestones, etc.)

**Step 2 — Generating:**
- Animated loading state with streaming progress indicator
- Shows Gemini generating the report in real-time

**Step 3 — Review & Edit:**
- Full-width rich text editor (Tiptap, same as meeting minutes)
- Branded preview panel alongside editor
- Action toolbar: Edit / Preview toggle, Finalize, Download PDF, Download Word, Email, Save Draft

**Step 4 — History Tab:**
- List of previously generated reports for this project
- Filter by type (weekly/monthly), date range
- Re-download, re-email, or delete old reports

---

### 2. `ReportBrandedTemplate` (used for PDF/print rendering)

An off-screen renderable div that formats the report content with the user's company branding:

```
┌─────────────────────────────────────┐
│  [LOGO]   COMPANY NAME              │
│           Address | Phone | Email   │
│─────────────────────────────────────│
│  PROJECT PROGRESS REPORT            │
│  Project: [Name]                    │
│  Period:  [Start] — [End]           │
│  Date:    [Generated On]            │
├─────────────────────────────────────┤
│  [AI-generated content here]        │
│                                     │
│  Sections with headings, tables,    │
│  bullet lists, financial summaries  │
│                                     │
├─────────────────────────────────────┤
│  Prepared by: [User name]           │
│  [Company footer text]              │
└─────────────────────────────────────┘
```

---

## Integration Point: Project Header

In `ProjectDetailPage.tsx`, a new **"Reports" button** is added to the header action area (next to Activity / Discuss / Edit buttons):

```
[Activity] [Discuss] [Reports ↓] [Edit]
```

The Reports button opens `ReportGeneratorDialog`. The dialog is self-contained.

---

## Technical Implementation Steps

1. **Database migration** — Create `project_progress_reports` table with RLS
2. **Edge function** — Create `supabase/functions/generate-progress-report/index.ts`
   - Batch-fetch all project data
   - Build type-specific AI prompt
   - Call Gemini 2.0 Flash, stream SSE response
3. **Hook** — Create `src/hooks/useProgressReports.ts`
   - `useProgressReports(projectId)` — fetch saved reports
   - `useGenerateProgressReport()` — streaming mutation
   - `useSaveProgressReport()` — save/update draft or finalized
   - `useDeleteProgressReport()` — delete
4. **Components**
   - `src/components/projects/ReportGeneratorDialog.tsx` — main dialog with steps
   - Branded HTML template builder function (inline, like `buildMinutesHtml`)
5. **Page update** — Add Reports button to `ProjectDetailPage.tsx` header

---

## Branding Logic

```
if (company_branding exists for user) {
  use: company_name, logo_url, primary_color, address, phone, email, website
} else {
  fallback: "APAS Consulting" with navy/blue default theme
}
```

This means any subscriber using the system gets their own company letterhead automatically — zero configuration needed if they've already set up their branding in Settings.

---

## Export Formats

- **PDF**: Uses existing `generatePDF()` utility (html2canvas + jsPDF) on the branded template div
- **Word (.docx)**: Uses existing `docx` package, converts HTML sections to Word paragraphs with styled headings
- **Email**: Uses existing `useSendEmail` hook with the branded HTML as the email body
- **Print**: Opens `window.print()` with print-optimized CSS
